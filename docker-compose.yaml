
name: subaybay

services:
  app:
    build: app
    restart: always
    ports: 
      - ${APP_PORT}:3000
    env_file:
      - ./.env.development
    depends_on:
      - backend
      - database

  database:
    image: mongo
    restart: always
    command: ["--replSet", "rs0", "--bind_ip_all", "--port", "27017"]
    extra_hosts:
      - "host.docker.internal:host-gateway"
    healthcheck:
        test: echo "try { rs.status() } catch (err) { rs.initiate({_id:'rs0',members:[{_id:0,host:'host.docker.internal:27017'}]}) }" | mongosh --port 27017 --quiet
        interval: 5s
        timeout: 30s
        start_period: 0s
        start_interval: 1s
        retries: 30
    volumes:
       - db-data:/data/db
       - ./mongo-init.js:/docker-entrypoint-initdb.d/mongo-init.js:ro
    ports:
      - ${DATABASE_PORT}:27017
    env_file:
      - ./.env.development

  backend:
    build: backend
    restart: always
    ports: 
      - ${BACKEND_PORT}:8080
    env_file:
      - ./.env.development
    depends_on:
      - database


volumes:
  db-data:

